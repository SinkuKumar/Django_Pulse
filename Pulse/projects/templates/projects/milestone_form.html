{% extends 'app/app.html' %} 
{% block title %}{{ view.object.pk|yesno:"Edit Milestone,Create Milestone" }}{% endblock %}

{% block extra_head %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block main %}
<h2>{{ view.object.pk|yesno:"Edit Milestone,Create Milestone" }}</h2>
<form method="post">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div class="form-group">
        {{ form.title.label_tag }}
        {{ form.title }}
        {{ form.title.errors }}
    </div>
    <div class="form-group">
        {{ form.description.label_tag }}
        {{ form.description }}
        {{ form.description.errors }}
    </div>
    <div class="form-group">
        <label for="id_status">Status</label>
        <select id="id_status" name="status" class="form-control">
            <option value="">Loading...</option>
        </select>
    </div>
    <div class="form-group">
        {{ form.due_date.label_tag }}
        {{ form.due_date }}
        {{ form.due_date.errors }}
    </div>
    <div class="form-group">
        {{ form.responsible.label_tag }}
        {{ form.responsible }}
        {{ form.responsible.errors }}
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
</form>

<script>
$(document).ready(function() {
    $.ajax({
        url: "{% url 'projects:ajax_milestone_status' %}",
        type: 'GET',
        success: function(data) {
            const select = $('#id_status');
            select.empty();
            select.append('<option value="">Select Status</option>');
            data.forEach(function(status) {
                const selected = "{{ form.instance.status.id|default:'' }}" == status.id ? 'selected' : '';
                select.append(`<option value="${status.id}" ${selected}>${status.name}</option>`);
            });
        }
    });
});
</script>
{% endblock %}
