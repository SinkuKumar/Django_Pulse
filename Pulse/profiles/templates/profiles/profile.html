{% extends 'app/app.html' %}
{% load static %}
{% block title %}Pulse Profile{% endblock %}

{% block main %}
<div class="container py-4">
  <div class="row g-4">
    <!-- Profile Sidebar -->
    <div class="col-12 col-lg-4">
      <div class="card profile-card h-100">
        <div class="card-body text-center">
          <div class="avatar-wrapper d-flex justify-content-center mb-3">
            {% if request.user.profile.avatar %}
              <img src="{{ request.user.profile.avatar.url }}" alt="{{ request.user.username }}"
                class="avatar rounded-circle" style="max-width: 150px; height: 150px; object-fit: cover" />
            {% else %}
              <img src="{% static 'default-avatar.png' %}" alt="default avatar"
                class="avatar rounded-circle" style="max-width: 150px; height: 150px; object-fit: cover" />
            {% endif %}
          </div>
          <h2 class="h5 mb-1">{{ request.user.first_name }} {{ request.user.last_name }}</h2>
          <p class="text-secondary mb-1">@{{ request.user.username }}</p>
          <p class="text-secondary small mb-2">{{ request.user.email }}</p>
          <p class="text-muted small mb-3">{{ request.user.profile.bio }}</p>
          <p class="text-muted small mb-3">{{ request.user.profile.phone }}</p>
        </div>
      </div>
    </div>

    <!-- Tabs Section -->
    <div class="col-12 col-lg-8">
      <ul class="nav nav-tabs flex-wrap" id="profileTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#user">User</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#profile">Profile</a></li>
        <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#security">Security</a></li>
      </ul>

      <div class="tab-content border border-top-0 p-3 rounded-bottom shadow-sm">
        <!-- User Tab -->
        <div class="tab-pane fade show active" id="user">
          <form method="post">
            {% csrf_token %}
            {{ user_form.as_p }}
            <button type="submit" name="user_form" class="btn btn-primary">Save</button>
          </form>
        </div>

        <!-- Profile Tab -->
        <div class="tab-pane fade" id="profile">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ profile_form.as_p }}
            <button type="submit" name="profile_form" class="btn btn-success">Update</button>
          </form>
        </div>

        <!-- Security Tab -->
        <div class="tab-pane fade" id="security">
          <form id="passwordChangeForm">
            {% csrf_token %}
            {{ password_form.as_p }}
            <button type="submit" class="btn btn-danger">Change Password</button>
          </form>
          <div id="passwordMessage" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.querySelector("#passwordChangeForm").addEventListener("submit", function(e) {
  e.preventDefault();
  let formData = new FormData(this);
  fetch("{% url 'change_password_ajax' %}", {
    method: "POST",
    headers: { "X-CSRFToken": "{{ csrf_token }}" },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    let msg = document.querySelector("#passwordMessage");
    if (data.success) {
      msg.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
      this.reset();
    } else {
      let errors = "";
      if (data.errors) {
        for (let field in data.errors) {
          errors += `<p><strong>${field}:</strong> ${data.errors[field].join(", ")}</p>`;
        }
      } else {
        errors = data.message;
      }
      msg.innerHTML = `<div class="alert alert-danger">${errors}</div>`;
    }
  });
});
</script>
{% endblock %}
